<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Quejas - La Alemana</title>
    <style>
        /* ESTILOS CSS */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f4; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        header { background-color: #FFC107; width: 100%; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; color: #333; }
        .screen { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 1200px; margin-top: 30px; display: none; margin-bottom: 50px; } 
        .active { display: block; }
        .login-box { max-width: 400px; margin: 50px auto; text-align: center; }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        input:disabled { background-color: #e9ecef; color: #495057; font-weight: bold; }
        button { background-color: #FFC107; color: #333; border: none; padding: 12px 20px; cursor: pointer; font-weight: bold; border-radius: 4px; transition: background 0.3s; }
        button:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-action { background-color: #17a2b8; color: white; font-size: 0.8em; padding: 5px 10px; }
        .btn-action:hover { background-color: #138496; }
        
        /* Estilos de Tabla con Scroll */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85em; min-width: 1500px; } 
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #333; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        
        /* Columna de descripción y acción más ancha */
        .desc-col { min-width: 200px; max-width: 300px; white-space: pre-wrap; }
        
        .status-select { padding: 5px; font-size: 0.9em; border-radius: 4px; border: 1px solid #ccc; background-color: white; cursor: pointer; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 0.9em; display: inline-block; }
        .st-activa { background-color: #e2e6ea; color: #333; border: 1px solid #ccc; }
        .st-cerrada { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        /* Spinner de carga */
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #FFC107; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL DE ACCIÓN */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <header>
        <h1>La Alemana - Gestión de Clientes</h1>
        <div id="userInfo" style="font-size: 14px; margin-top: 5px; font-weight: bold;"></div>
    </header>

    <div id="loading">
        <div class="spinner"></div>
        <p>Procesando datos en la nube...</p>
    </div>

    <div id="loginScreen" class="screen active login-box">
        <h2>Iniciar Sesión</h2>
        <input type="text" id="username" placeholder="Usuario">
        <input type="password" id="password" placeholder="Contraseña">
        <button onclick="login()">Ingresar</button>
    </div>

    <div id="registerScreen" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Registro de Nueva Queja</h2>
            <button onclick="changeToTableScreen()">Ver Quejas Registradas</button>
        </div>
        <hr>
        
        <div class="form-grid">
            <div class="full-width">
                <label>Registrado por:</label>
                <input type="text" id="registradoPor" disabled>
            </div>
            <div>
                <label>Fecha Recibida:</label>
                <input type="date" id="fechaRecepcion">
            </div>
            
            <div>
                <label>Fecha Suceso:</label>
                <input type="date" id="fechaSuceso">
            </div>
            <div class="full-width">
                <label>Hora Aprox. del Suceso:</label>
                <input type="time" id="horaSuceso">
            </div>
            <div>
                <label>Nombre Cliente:</label>
                <input type="text" id="nomCliente" placeholder="Ej: Juan Pérez">
            </div>
            <div>
                <label>Teléfono Cliente:</label>
                <input type="text" id="telCliente" placeholder="(477) 000 0000">
            </div>
            <div class="full-width">
                <label>Descripción:</label>
                <textarea id="descripcion" rows="3"></textarea>
            </div>
            <div>
                <label>Categoría:</label>
                <select id="categoria">
                    <option value="variaciondePeso">Variación de peso</option>
                    <option value="productoCambiado">Producto cambiado</option>
                    <option value="calidaddeProducto">Calidad de producto</option>
                    <option value="demoras">Demoras</option>
                    <option value="faltadeTicket">Falta de ticket</option>
                    <option value="negoProducto">Negó producto</option>
                    <option value="malaAtencion">Mala Atención</option>
                    <option value="higiene">Higiene</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
            <div>
                <label>Distrito:</label>
                <select id="distrito">
                    <option value="Distrito 1">Distrito 1</option>
                    <option value="Distrito 2">Distrito 2</option>
                    <option value="Distrito 3">Distrito 3</option>
                    <option value="Distrito 4">Distrito 4</option>
                    <option value="Distrito 5">Distrito 5</option>
                </select>
            </div>
            <div>
                <label>Supervisor (SOP):</label>
                <select id="sop">
                    <option value="Anel Santoyo">Anel Santoyo</option>
                    <option value="Jesús Mil">Jesús Mil</option>
                    <option value="Ulises Anda">Ulises Anda</option>
                    <option value="Luis Villegas">Luis Villegas</option>
                    <option value="Armando Vargas">Armando Vargas</option>
                    <option value="Juan Piceno">Juan Piceno</option>
                </select>
            </div>
            <div>
                <label>Tienda:</label>
                <select id="tienda">
                    <option value="01 AV. MEXICO">01 AV. MEXICO</option>
                    <option value="02 BELISARIO">02 BELISARIO</option>
                    <option value="03 BALCONES">03 BALCONES</option>
                    <option value="05 TORRES LANDA">05 TORRES LANDA</option>
                    <option value="06 PRADERA">06 PRADERA</option>
                    <option value="07 ABASTOS">07 ABASTOS</option>
                    <option value="08 SAN MIGUEL">08 SAN MIGUEL</option>
                    <option value="09 MADRAZO">09 MADRAZO</option>
                    <option value="10 DELTA">10 DELTA</option>
                    <option value="11 JUAREZ">11 JUAREZ</option>
                    <option value="12 ECHEVESTE">12 ECHEVESTE</option>
                    <option value="13 SAN PEDRO">13 SAN PEDRO</option>
                    <option value="14 COECILLO">14 COECILLO</option>
                    <option value="15 LEON II">15 LEON II</option>
                    <option value="16 TROJES">16 TROJES</option>
                    <option value="17 SANTA CLARA">17 SANTA CLARA</option>
                    <option value="18 OLIMPICA">18 OLIMPICA</option>
                    <option value="19 VILLAS DE LEON">19 VILLAS DE LEON</option>
                    <option value="21 SION">21 SION</option>
                    <option value="22 VALLE REAL">22 VALLE REAL</option>
                    <option value="23 HIDALGO 1">23 HIDALGO 1</option>
                    <option value="25 TELLEZ">25 TELLEZ</option>
                    <option value="26 LOMAS DE MEDINA">26 LOMAS DE MEDINA</option>
                    <option value="27 BOCANEGRA">27 BOCANEGRA</option>
                    <option value="28 MANDARINAS">28 MANDARINAS</option>
                    <option value="29 JOYAS">29 JOYAS</option>
                    <option value="30 AUSTRI">30 AUSTRI</option>
                    <option value="31 IBARRILLA">31 IBARRILLA</option>
                    <option value="32 CARCAMOS">32 CARCAMOS</option>
                    <option value="33 VILLAS DE SAN JUAN">33 VILLAS DE SAN JUAN</option>
                    <option value="34 MIRADOR">34 MIRADOR</option>
                    <option value="35 SAN FRANCISCO">35 SAN FRANCISCO</option>
                    <option value="36 PASEO DE LA PRESA">36 PASEO DE LA PRESA</option>
                    <option value="37 RIVERA CENTRO">37 RIVERA CENTRO</option>
                    <option value="38 SAN JUAN BOSCO">38 SAN JUAN BOSCO</option>
                    <option value="39 LA MERCED">39 LA MERCED</option>
                    <option value="40 21 DE MARZO">40 21 DE MARZO</option>
                    <option value="42 CARRO VERDE">42 CARRO VERDE</option>
                    <option value="43 LA LUZ">43 LA LUZ</option>
                    <option value="44 SILAO">44 SILAO</option>
                </select>
            </div>
            <div class="full-width">
                <label>Estatus:</label>
                <select id="estatus">
                    <option value="activa">activa</option>
                    <option value="cerrada">cerrada</option>
                </select>
            </div>
        </div>
        <br>
        <button class="btn-success" onclick="guardarQuejaCloud()">Registrar Queja (Guardar en Nube)</button>
        <button class="btn-danger" onclick="logout()">Cerrar Sesión</button>
    </div>

    <div id="listScreen" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Bitácora de Quejas (Nube)</h2>
            <button onclick="showScreen('registerScreen')">Nueva Queja</button>
        </div>
        <hr>
        
        <div style="overflow-x:auto;">
            <table id="quejasTable">
                <thead>
                    <tr>
                        <th>ID (Folio)</th>
                        <th>Fecha Rec.</th>
                        <th>Fecha Suceso</th>
                        <th>Registró</th>
                        <th>Cliente</th>
                        <th>Teléfono</th>
                        <th>Descripción</th>
                        <th>Categoría</th>
                        <th>Distrito</th>
                        <th>Supervisor</th>
                        <th>Tienda</th>
                        <th>Acción / Resolución</th> <th>Estatus</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <br>
        <button class="btn-success" onclick="exportarCSV()">Descargar CSV (Excel)</button>
        <p style="font-size:12px; color:gray; margin-top:10px;">* Nota: Si eres Supervisor, solo verás tus reportes.</p>
    </div>

    <div id="actionModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Registrar Resolución / Acción</h3>
            <p id="modalQuejaId" style="font-weight:bold; color:#666;"></p>
            <textarea id="modalActionText" rows="5" placeholder="Escribe aquí la resolución acordada con el cliente..."></textarea>
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn-danger" onclick="closeActionModal()">Cancelar</button>
                <button class="btn-success" onclick="saveActionToCloud()">Guardar Acción</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // URL DEL SCRIPT (ASEGURATE QUE SEA LA ACTUALIZADA)
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDfjs4iMCDbwVMGwYPz0sMju2MrEpzIlH3gLCaFci1jg_GYelFmWJTeHxrkkviikKLPg/exec";
        // ==========================================

        let currentUser = "";
        let globalQuejas = []; 
        let currentEditingId = null; // Para saber qué queja estamos editando

        // MAPA DE PERMISOS: Usuario -> Nombre Real SOP
        const supervisorMap = {
            'juan': 'Juan Piceno',
            'mil': 'Jesús Mil',
            'anel': 'Anel Santoyo',
            'luis': 'Luis Villegas',
            'armando': 'Armando Vargas',
            'ulises': 'Ulises Anda'
        };

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(div => div.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function login() {
            const baseDeDatos = {
                'admin': '1234admin',
                'rosalina': 'rp1234',
                'chava': 'sem0987',
                'rey': 'ort5678',
                'juan': 'picjua',
                'mil': '1000chuy',
                'anel': 'santoyosop',
                'luis': 'sopvill',
                'armando': 'avar0987',
                'ulises': 'andauli'
            };

            const user = document.getElementById('username').value.toLowerCase(); // Convertir a minúsculas por seguridad
            const pass = document.getElementById('password').value;

            if (baseDeDatos[user] && baseDeDatos[user] === pass) {
                currentUser = user;
                
                let rolTexto = supervisorMap[user] ? `Supervisor (${supervisorMap[user]})` : "Administrador/General";
                
                document.getElementById('userInfo').innerText = `Usuario: ${currentUser} | Rol: ${rolTexto}`;
                document.getElementById('registradoPor').value = currentUser;
                
                showScreen('registerScreen');
                document.getElementById('fechaRecepcion').valueAsDate = new Date();
            } else {
                alert("Usuario o contraseña incorrectos");
            }
        }

        function logout() {
            if(confirm("Salir?")) {
                currentUser = "";
                location.reload();
            }
        }

        // --- FUNCIONES DE LA NUBE ---

        function guardarQuejaCloud() {
            const nomCliente = document.getElementById('nomCliente').value;
            if(!nomCliente) { alert("Falta nombre cliente"); return; }
            
            showLoading(true);

            const form = new FormData();
            form.append('registradoPor', currentUser);
            form.append('fechaRecepcion', document.getElementById('fechaRecepcion').value);
            form.append('fechaSuceso', document.getElementById('fechaSuceso').value);
            form.append('horaSuceso', document.getElementById('horaSuceso').value);
            form.append('nomCliente', document.getElementById('nomCliente').value);
            form.append('telCliente', document.getElementById('telCliente').value);
            form.append('descripcion', document.getElementById('descripcion').value);
            form.append('categoria', document.getElementById('categoria').value);
            form.append('distrito', document.getElementById('distrito').value);
            form.append('sop', document.getElementById('sop').value);
            form.append('tienda', document.getElementById('tienda').value);
            // La acción NO se envía al registrar
            form.append('estatus', document.getElementById('estatus').value);

            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: form })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if(data.result === 'success') {
                    alert("✅ REGISTRO EXITOSO\nFolio: " + data.idGenerado);
                    limpiarFormulario();
                } else {
                    alert("Error al guardar: " + JSON.stringify(data));
                }
            })
            .catch(error => {
                showLoading(false);
                alert("Error de conexión: " + error);
            });
        }

        function changeToTableScreen() {
            showScreen('listScreen');
            cargarDatosCloud();
        }

        function cargarDatosCloud() {
            showLoading(true);
            fetch(GOOGLE_SCRIPT_URL + "?action=read")
            .then(res => res.json())
            .then(data => {
                globalQuejas = data; 
                renderTable(data);
                showLoading(false);
            })
            .catch(err => {
                showLoading(false);
                alert("No se pudieron cargar los datos.");
            });
        }

        function renderTable(quejas) {
            const tbody = document.querySelector('#quejasTable tbody');
            tbody.innerHTML = "";
            
            // 1. FILTRADO: Si el usuario está en el mapa de supervisores, filtramos
            let datosFiltrados = quejas;
            if (supervisorMap[currentUser]) {
                const nombreSOP = supervisorMap[currentUser];
                datosFiltrados = quejas.filter(q => q['Supervisor (SOP)'] === nombreSOP || q.sop === nombreSOP); 
                // Nota: Usamos q['Supervisor (SOP)'] si viene del JSON formateado o q.sop si viene directo. 
                // En el script puse headers, así que probablemente venga como "Supervisor (SOP)" o "sop" dependiendo de tu header exacto en Excel.
                // Ajuste de seguridad: Buscamos coincidencia flexible
                datosFiltrados = quejas.filter(q => {
                    let s = q.sop || q['Supervisor (SOP)'] || ""; // Intenta leer el campo
                    return s === nombreSOP;
                });
            }

            datosFiltrados.reverse().forEach(q => {
                // Recuperar valores (adaptable a los nombres de cabecera del Excel)
                let id = q.id || q['ID (Folio)'];
                let desc = q.descripcion || q['Descripción'];
                let accion = q.accion || q['Acción'] || "";
                let estatus = q.estatus || q['Estatus'];
                let sopName = q.sop || q['Supervisor (SOP)'];

                // 2. LOGICA DEL BOTÓN ACCIÓN (SOLO ESCRITURA UNA VEZ)
                let accionHtml = "";
                if (accion && accion.trim().length > 1) {
                    // CASO 1: YA EXISTE ACCIÓN -> SE MUESTRA SOLO TEXTO (BLOQUEADO)
                    accionHtml = `
                        <div style="background-color:#f8f9fa; padding:5px; border-left: 3px solid #28a745; border-radius:3px;">
                            <span style="font-size:0.8em; font-weight:bold; color:#28a745;">✅ Resolución Registrada:</span><br>
                            <span style="font-size:0.9em; color:#333;">${accion}</span>
                        </div>
                    `;
                } else {
                    // CASO 2: ESTÁ VACÍA -> PERMITIR REGISTRAR
                    accionHtml = `<button class="btn-action" onclick="openActionModal('${id}', '')">Registrar Acción ➕</button>`;
                }

                // 3. LOGICA DEL ESTATUS (Bloqueado para supervisores)
                let statusHtml = "";
                const isSupervisor = supervisorMap.hasOwnProperty(currentUser);

                if (isSupervisor) {
                    // Modo solo lectura
                    let claseColor = estatus === 'activa' ? 'st-activa' : 'st-cerrada';
                    statusHtml = `<span class="status-badge ${claseColor}">${estatus}</span>`;
                } else {
                    // Modo edición (Admin)
                    statusHtml = `
                        <select class="status-select" onchange="actualizarCampoCloud('${id}', 'Estatus', this.value)">
                            <option value="activa" ${estatus === 'activa' ? 'selected' : ''}>activa</option>
                            <option value="cerrada" ${estatus === 'cerrada' ? 'selected' : ''}>cerrada</option>
                        </select>
                    `;
                }

                let row = `<tr>
                    <td><b>${id}</b></td>
                    <td>${formatDate(q.fechaRecepcion || q['Fecha Rec.'])}</td>
                    <td>${formatDate(q.fechaSuceso || q['Fecha Suceso'])}</td>
                    <td>${q.registradoPor || q['Registró']}</td>
                    <td>${q.nomCliente || q['Cliente']}</td>
                    <td>${q.telCliente || q['Teléfono'] || ''}</td>
                    <td class="desc-col">${desc || ''}</td>
                    <td>${q.categoria || q['Categoría']}</td>
                    <td>${q.distrito || q['Distrito']}</td>
                    <td>${sopName}</td>
                    <td>${q.tienda || q['Tienda']}</td>
                    <td class="desc-col">${accionHtml}</td>
                    <td>${statusHtml}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // --- MANEJO DEL MODAL DE ACCIÓN ---
        function openActionModal(id, currentText) {
            currentEditingId = id;
            document.getElementById('modalQuejaId').innerText = "Folio: " + id;
            document.getElementById('modalActionText').value = currentText;
            document.getElementById('actionModal').style.display = 'flex';
        }

        function closeActionModal() {
            document.getElementById('actionModal').style.display = 'none';
            currentEditingId = null;
        }

        function saveActionToCloud() {
            const nuevaAccion = document.getElementById('modalActionText').value;
            if(!currentEditingId) return;

            actualizarCampoCloud(currentEditingId, 'Acción', nuevaAccion);
            closeActionModal();
        }

        // FUNCIÓN GENÉRICA PARA ACTUALIZAR CAMPOS (Acción o Estatus)
        function actualizarCampoCloud(id, columna, valor) {
            showLoading(true);
            const form = new FormData();
            form.append('action', 'updateField');
            form.append('id', id);
            form.append('columna', columna); // Debe coincidir con el header exacto en Excel (Acción, Estatus)
            form.append('valor', valor);

            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: form })
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if(data.result === 'success') {
                    // Recargar tabla para ver cambios
                    cargarDatosCloud(); 
                } else {
                    alert("Error al actualizar: " + data.message);
                }
            })
            .catch(err => {
                showLoading(false);
                alert("Error de red al actualizar");
            });
        }

        function formatDate(dateStr) {
            if(!dateStr) return "";
            return String(dateStr).substring(0,10);
        }

        function limpiarFormulario() {
            document.getElementById('nomCliente').value = "";
            document.getElementById('telCliente').value = "";
            document.getElementById('descripcion').value = "";
            // Accion ya no existe en form
            document.getElementById('fechaSuceso').value = "";
            document.getElementById('horaSuceso').value = "";
        }

        function exportarCSV() {
            if(globalQuejas.length === 0) { alert("Sin datos"); return; }
            let csvContent = "ID,Cliente,Descripcion,Accion,Estatus\n"; // Simplificado para ejemplo
            
            // Para exportar todo, puedes iterar globalQuejas completo
            // Pero si eres supervisor, tal vez quieras exportar solo lo filtrado.
            // Por simplicidad, exportamos lo que hay en globalQuejas (todo) o puedes filtrar aquí también.
            
            globalQuejas.forEach(q => {
                 let row = [
                    q.id || q['ID (Folio)'], 
                    q.nomCliente || q['Cliente'],
                    (q.descripcion || q['Descripción'] || '').replace(/,/g, ' '),
                    (q.accion || q['Acción'] || '').replace(/,/g, ' '),
                    q.estatus || q['Estatus']
                ].join(",");
                csvContent += row + "\n";
            });
            
            const blob = new Blob([csvContent], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'reporte_quejas.csv';
            a.click();
        }
    </script>
</body>
</html>
